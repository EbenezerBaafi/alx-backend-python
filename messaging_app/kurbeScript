#!/bin/bash

# kurbeScript - Kubernetes Local Setup and Verification Script
# This script starts a Minikube cluster, verifies it's running, and retrieves pods

set -e  # Exit on any error

echo "=========================================="
echo "Kubernetes Local Setup Script"
echo "=========================================="
echo ""

# Check if minikube is installed
echo "Checking if Minikube is installed..."
if ! command -v minikube &> /dev/null; then
    echo "❌ Error: Minikube is not installed!"
    echo ""
    echo "Please install Minikube first:"
    echo "  macOS:   brew install minikube"
    echo "  Linux:   curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64"
    echo "           sudo install minikube-linux-amd64 /usr/local/bin/minikube"
    echo "  Windows: choco install minikube"
    echo ""
    echo "For more details: https://minikube.sigs.k8s.io/docs/start/"
    exit 1
fi
echo "✅ Minikube is installed: $(minikube version --short)"
echo ""

# Check if kubectl is installed
echo "Checking if kubectl is installed..."
if ! command -v kubectl &> /dev/null; then
    echo "❌ Error: kubectl is not installed!"
    echo ""
    echo "Please install kubectl first:"
    echo "  macOS:   brew install kubectl"
    echo "  Linux:   curl -LO https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    echo "  Windows: choco install kubernetes-cli"
    echo ""
    echo "For more details: https://kubernetes.io/docs/tasks/tools/"
    exit 1
fi
echo "✅ kubectl is installed: $(kubectl version --client --short 2>/dev/null || kubectl version --client)"
echo ""

# Start Minikube cluster
echo "Starting Minikube cluster..."
echo "(This may take a few minutes on first run)"
echo ""

if minikube status &> /dev/null; then
    echo "ℹ️  Minikube cluster is already running"
else
    minikube start --driver=docker 2>&1 || {
        echo ""
        echo "⚠️  Failed with docker driver, trying with default driver..."
        minikube start
    }
fi
echo ""
echo "✅ Minikube cluster started successfully!"
echo ""

# Verify cluster is running
echo "=========================================="
echo "Verifying Cluster Status"
echo "=========================================="
echo ""
kubectl cluster-info
echo ""

# Get cluster nodes
echo "=========================================="
echo "Cluster Nodes"
echo "=========================================="
echo ""
kubectl get nodes
echo ""

# Retrieve available pods
echo "=========================================="
echo "Available Pods (All Namespaces)"
echo "=========================================="
echo ""
kubectl get pods --all-namespaces
echo ""

# Display helpful next steps
echo "=========================================="
echo "✅ Setup Complete!"
echo "=========================================="
echo ""
echo "Your Kubernetes cluster is ready to use!"
echo ""
echo "Useful commands:"
echo "  minikube dashboard    - Open Kubernetes dashboard"
echo "  minikube stop         - Stop the cluster"
echo "  minikube delete       - Delete the cluster"
echo "  kubectl get pods      - List pods in default namespace"
echo "  kubectl get services  - List services"
echo ""
echo "To deploy your first app, try:"
echo "  kubectl create deployment hello-minikube --image=kicbase/echo-server:1.0"
echo "  kubectl expose deployment hello-minikube --type=NodePort --port=8080"
echo ""